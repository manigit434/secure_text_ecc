{% extends "admin/base_site.html" %}

{% block title %}Confirm Decryption{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; margin-top: 20px;">

  <h2>ğŸ” Admin Decryption Confirmation</h2>

  <p>
    You are attempting to decrypt
    <strong>Encrypted Submission #{{ sub.id }}</strong>.
  </p>

  <p style="color: #a00;">
    âš ï¸ This action is sensitive and will be logged.
  </p>

  <hr>

  {% if error %}
    <div class="errornote">
      {{ error }}
    </div>
  {% endif %}

  {% if plaintext %}
    <!-- =========================
         DECRYPTED RESULT
    ========================== -->
    <h3>ğŸ”“ Decrypted Plaintext</h3>

    <!-- Watermark -->
    <div id="watermark">
      CONFIDENTIAL Â· {{ request.user.username }} Â· {{ request.META.REMOTE_ADDR }}
    </div>

    <pre
      id="plaintext"
      style="
        user-select: none;
        pointer-events: none;
        background: #000;
        color: #00ff00;
        padding: 1rem;
        border-radius: 6px;
        white-space: pre-wrap;
        font-family: monospace;
      "
    >
{{ plaintext }}
    </pre>

    <br>

    <a href="{% url 'admin:core_submission_changelist' %}" class="button">
      â¬… Back to Encrypted Submissions
    </a>

    <script>
      // Block copy, cut, right-click
      document.addEventListener("copy", e => e.preventDefault());
      document.addEventListener("cut", e => e.preventDefault());
      document.addEventListener("contextmenu", e => e.preventDefault());

      // Blur plaintext when tab/window loses focus
      const plaintext = document.getElementById("plaintext");

      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          plaintext.style.filter = "blur(12px)";
        } else {
          plaintext.style.filter = "none";
        }
      });

      window.addEventListener("blur", () => {
        plaintext.style.filter = "blur(12px)";
      });

      window.addEventListener("focus", () => {
        plaintext.style.filter = "none";
      });
    </script>

  {% else %}
    <!-- =========================
         PASSWORD CONFIRM FORM
    ========================== -->
    <form method="post" style="margin-top:20px;">
      {% csrf_token %}

      <fieldset class="module aligned">
        <div class="form-row">
          <label for="password">
            Confirm your admin password:
          </label>
          <input
            type="password"
            name="password"
            id="password"
            required
            style="width:300px;"
          >
        </div>

        <div class="form-row" style="margin-top:15px;">
          <label class="form-label fw-semibold">
            Reason for Decryption (Required)
          </label>
          <textarea
            name="reason"
            class="form-control"
            rows="3"
            required
            placeholder="Enter justification for accessing this data"></textarea>
        </div>
      </fieldset>

      <div style="margin-top:15px;">
        <button type="submit" class="button default">
          ğŸ”“ Confirm & Decrypt
        </button>

        <a
          href="{% url 'admin:core_submission_changelist' %}"
          class="button cancel-link"
          style="margin-left:10px;"
        >
          Cancel
        </a>
      </div>
    </form>
  {% endif %}

</div>
{% endblock %}